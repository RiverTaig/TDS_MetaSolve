<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="utf-8">
    <title>MetaSolve Viewer</title>
    <style type="text/css">
        .portRow{
            color:#FFDD00;
            background-color: #241F0C;
            font-weight: 800;
            font-size:14px;
            text-align: center;
        }
        .colName{
            font-size:12px;
            font-weight:bold;
            color: #009B3E;
        }        
        .even{
            font-size:10px;
            background-color: #ffffff;
        }
        .odd{
            font-size:10px;
            background-color: #cccccc;
        } 
        .dynamicContent{
            background-color: #2FB4E9;
            display:none;
            //width: 150px;
            position: absolute;
            left: 250px;
            top: 10px;
            z-index: 5;
        } 
        #header{
            color:#000000;
            //background-color: #009B3E;
            font-weight: bold;
            width: 100px;
            font-size:12px;
        }
        #value{
            //color:#000000;
            background-color: #FFFFFF;
            font-size:10px;
        }        

    </style>
   
    <script src="https://code.jquery.com/jquery-1.10.2.js" > </script>
    <script >
        var c = "";
        var cw = 0;
        var ch = 0;
        $( document ).ready(function() {
            //alert("ready");
            c = document.getElementById('myCanvas');
            cw = c.width;
            ch = c.height;
            
            CreatePorts();
            //alert("done creat ports ");
          });
        function getMousePos( evt) {
            return {
                x: evt.clientX ,
                y: evt.clientY 
                };
        }
        
        function GetPortNumberUnderCursor (evt,x,y){
            if(x == 0){
                //alert("in getMousePos");
                var mousePos = getMousePos( evt);
                x = mousePos.x;
                y = mousePos.y;
            }
            var canvasWidth = cw - 5;
            var canvasHeight = ch - 5;
            var columnWidth = (canvasWidth / 18)   ;
            var rowHeight = (canvasHeight / 24)   ;
            var col = Math.round(x / columnWidth,0);
            var row = Math.round(y / rowHeight,0);
            var portNumber = ((row - 1) * 18 ) + col;

            return portNumber;
        }

        function GetMetaSolveData() {
            //alert('GetMetaSolveData');
            $.ajax({

                url: "http://lake:6080/arcgis/rest/services/TDS/MapServer/exts/TDS_SOE/MetaSolveOperation?CableName=asdf&FiberName=asdf&f=pjson"
            }).done(function(data) {
                //alert('done');
                metaSolveData = $.parseJSON(data);
                ColorGrid()
                //alert("asdf " + data);
            }).always(function(data,status,errorThrown){
                //alert('always et: ' + errorThrown);
            });

        }
        function GetMSDAtPort(portNumber){
            try{
                for (var i = 0; i < metaSolveData.length  ; i++) {
                    if(metaSolveData[i].FiberPair == portNumber){
                        return metaSolveData[i];
                    }
                }
                return null;
            }
            catch(Exception){
                alert("Exception in GetMSDAtPort");
                return metaSolveData[0];
            }
        }
        function ColorGrid()
        {
                var c = document.getElementById('myCanvas');
                c.addEventListener('mousemove', function(evt) {
                    //var dc = $('.dynamicContent');
                    //dc.hide();
                }, false);
                c.addEventListener('mousedown', function(evt) {
                    
                    var portNumber = GetPortNumberUnderCursor(evt,0,0);            
                    //alert(portNumber);       
                    var msd = GetMSDAtPort(portNumber); //metaSolveData[portNumber-1];
                    //alert("port / pedestal " + portNumber + " / " +  msd.Pedestal);
                        if(event.ctrlKey)
                        {
                            $.ajax({

                                url: "http://localhost:6080/arcgis/rest/services/TDS/MapServer/exts/TDS_SOE/SetMetaSolveZoomOperation?Pedestal=" +  msd.Pedestal +"&FieldToQuery=COMMENTS&FeatureClassName=SECOM.ARCFM.PATCHLOCATION&f=pjson"
                            }).done(function(data) {
                                //alert("it worked " + data.toString());
                            }).always(function(data,status,errorThrown){
                                //alert('always ');
                            });
                            return;
                        }                    
                    $('#port').html("Port: " + portNumber);
                    if(msd != null){
                        $('#exchangeValue').html(msd.Exchange);
                        $('#cableNameValue').html(msd.CableName);
                        $('#fiberPairValue').html(msd.FiberPair);
                        $('#remarsValue').html(msd.Remarks);
                        $('#statusValue').html(msd.Status);
                        $('#cableTypeValue').html(msd.CableType);
                        $('#dsaNumberValue').html(msd.DSANum);
                        $('#accessPointValue').html(msd.AccessPoint);
                        $('#cableNameValue').html(msd.CableName);
                        $('#routeValue').html(msd.Route);
                        $('#pedestalValue').html(msd.Pedestal);
                        $('#apAddressValue').html(msd.ApAddress);
                        $('#mapValue').html(msd.Map);
                        $('#conditionValue').html(msd.Condition);
                        $('#commentValue').html(msd.Comment);
                        $('#circuitIDValue').html(msd.CircuitID);
                        $('#circuitDesignIDValue').html(msd.CircuitDesignID);
                        $('#eulNameValue').html(msd.EULName);
                        $('#streetAddressValue').html(msd.StreetAddress);
                        $('#additionalInfoValue').html(msd.AddlInfo);
                        $('#clliCodeValue').html(msd.CLLICode);                        
                    }
                    else
                    {
                        var columns = ['exchange','cableName','fiberPair','remarks','status','cableType','dsaNumber',
                        'accessPoint','route','pedestal','apAddress','map','condition','comment','circuitID', 'circuitDesignID',
                        'eulName','streetAddress','additionalInfo','clliCode'];
                        for(var i = 0; i < columns.length; i++){
                            $("#" + columns[i] + "Value").html("No Data");
                        }
                    }
                    var dc = $('.dynamicContent');//document.getElementByClass('dynamicContent');
                    dc.mousedown(function(event) {
                        dc.hide();
                    });


                    var mc = $('#myCanvas');
                    //alert(dc.height());
                    var aboveMe = evt.pageY - dc.height();
                    var leftOfMe = evt.pageX - dc.width();

                    var yPos = aboveMe > 0 ? aboveMe : evt.pageY;
                    if(yPos + dc.height() > mc.height()){
                        yPos = mc.height() - dc.height();
                    }
                    var xPos = leftOfMe > 0 ? leftOfMe : evt.pageX;
                    //alert(leftOfMe);
                    dc.css({'top': yPos,'left': xPos});
 
                    dc.show();

                }, false);

                var ctx = c.getContext('2d');
                var counter = 0;
                for(c = 0; c < 24; c++){
                    for(r=0; r < 18; r++){
                        counter ++;
                        ctx.beginPath();
                        var x = 5 + (r * 24);
                        var y = 5 + (c*24);
                        //ctx.arc(X,20 + (c*30),10,0,2*Math.PI);
                        ctx.rect(x, y, 20,20);
                        var num = Math.random();
                        //var status = "Inservice";

                        var status = "NOT Inservice" ;
                        var xx = x+10;
                        var yy = y+10;
                        var pn = GetPortNumberUnderCursor(null,xx,yy);

                        var msdAtPort = GetMSDAtPort(pn);
                        try{
                            if(msdAtPort.Status == "Inservice")
                            {
                                //alert("Inservice");
                                status = "Inservice";
                            }
                            else
                            {
                                //alert("not inservice");
                            }
                        }
                        catch(Exception){
                            //alert("error");
                        }


                        
                        if(status == "Inservice"){
                        //if(num > .5){ //if(msdAtPort.Status == "inservice"){
                            ctx.fillStyle = '#ffdd00';
                            
                        }
                        else
                        {
                            ctx.fillStyle = '#a0a0a0';
                        }
                        ctx.fill();
                        ctx.lineWidth = 1;
                        ctx.strokeStyle = '#000000';
                        ctx.stroke();
                        ctx.fillStyle = 'black';
                        ctx.font = 'bold 10px Arial';
                        var offset = 2;
                        if(counter < 200) {offset = 1;} 
                        if(counter < 100) {offset = 4;}                            
                        if(counter < 10) {
                            offset = 7;
                        }
                        var xOff = x+offset;
                        ctx.fillText(counter, xOff, y+ 14);
                    }   
                }            
        }
        var metaSolveData = [];
        function CreatePorts(){
            try{
                GetMetaSolveData();


            }
            catch(Exception){
                alert("error " + Exception);
            }
        }
    </script> 
</head>
<body >
    <canvas id='myCanvas' width='437px'  height='581px' style='border:1px solid #d3d3d3;'>
        Your browser does not support the HTML5 canvas tag.
    </canvas>

    <div class='dynamicContent' >
        <TABLE width=200>
            <tr class='portRow' ><td colspan=2><div id="port"/>PORT</td></tr>
            <tr class='even'><td class='colName'>Exchange</td><td id='exchangeValue'> - </td></tr>
            <tr class='odd'><td class='colName'>Cable Name</td><td id='cableNameValue'> - </td></tr>
            <tr class='even'><td class='colName'>Fiber Pair</td><td id='fiberPairValue'> - </td></tr>
            <tr class='odd'><td class='colName'>Remarks</td><td id='remarksValue'> - </td></tr>
            <tr class='even'><td class='colName'>Status</td><td id='statusValue'> - </td></tr>
            <tr class='odd'><td class='colName'>Cable Type</td><td id='cableTypeValue'> - </td></tr>
            <tr class='even'><td class='colName'>DSA Number</td><td id='dsaNumberValue'> - </td></tr>
            <tr class='odd'><td class='colName'>Access Point</td><td id='accessPointValue'> - </td></tr>
            <tr class='even'><td class='colName'>Route</td><td id='routeValue'> - </td></tr>
            <tr class='odd'><td class='colName'>Pedestal</td><td id='pedestalValue'> - </td></tr>
            <tr class='even'><td class='colName'>AP Address</td><td id='apAddressValue'> - </td></tr>
            <tr class='odd'><td class='colName'>Map</td><td id='mapValue'> - </td></tr>
            <tr class='even'><td class='colName'>Condition</td><td id='conditionValue'> - </td></tr>
            <tr class='odd'><td class='colName'>Comment</td><td id='commentValue'> - </td></tr>
            <tr class='even'><td class='colName'>Circuit ID</td><td id='circuitIDValue'> - </td></tr>
            <tr class='odd'><td class='colName'>Circuit Design ID</td><td id='circuitDesignIDValue'> - </td></tr>
            <tr class='even'><td class='colName'>EUL Name</td><td id='eulNameValue'> - </td></tr>
            <tr class='odd'><td class='colName'>Street Address</td><td id='streetAddressValue'> - </td></tr>
            <tr class='even'><td class='colName'>Additional Info Address</td><td id='additionalInfoValue'> - </td></tr>
            <tr class='odd'><td class='colName'>CLLI Code</td><td id='clliCodeValue'> - </td></tr>
        </TABLE>
    </div>
</body>
</html>